<!DOCTYPE html>
<!--
 Copyright (c) 2020 Nadav Tasher
 https://github.com/NadavTasher/HeadlessTemplate/
-->
<html row lang="en">
<head>
    <!-- Charset -->
    <meta charset="UTF-8"/>
    <!-- App Description -->
    <meta name="description" content="Database manager.">
    <!-- Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, minimal-ui"/>
    <!-- Mobile -->
    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Mobile Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-title" content="Manager"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <!-- Icons -->
    <link rel="icon" href="https://nadavtasher.github.io/Template/bundle/src/resources/images/icons/icon.png"/>
    <link rel="apple-touch-icon" href="https://nadavtasher.github.io/Template/bundle/src/resources/images/icons/icon_apple.png"/>
    <!-- Modules & Resources -->
    <link rel="stylesheet" href="https://nadavtasher.github.io/Template/styles/style.css"/>
    <script type="text/javascript" src="https://nadavtasher.github.io/Template/modules/module.js"></script>
    <!-- App Title -->
    <title>Manager</title>
    <!-- No Script -->
    <noscript></noscript>
    <!-- App Sources -->
    <style type="text/css">
        :root {
            --theme: #FFFFFF;
            --passive: #333344;
            --active: #777788;
            --coaster: #DDDDEE;
        }

        body {
            max-width: 500px;
        }
    </style>
    <script type="text/javascript">
        let UI;

        async function load() {
            UI = await Module.import("UI");

            if (localStorage.getItem("token") !== null)
                UI.write("token", localStorage.getItem("token"));
        }

        function issue() {
            // Send an issue request to the database
            Database.execute("issue", {
                password: UI.read("password")
            }).then(value => {
                // Write token to UI
                UI.write("token", value);

                // Change page
                UI.view("access");
            });
        }

        function execute() {
            // Assemble the request
            let action = UI.read("action");
            let parameters = {};

            // Check parameters and append to object
            if (UI.read("token").length > 0) {
                parameters.token = UI.read("token");

                // Save token to localStorage
                localStorage.setItem("token", UI.read("token"));

                if (UI.read("scope").length > 0) {
                    parameters.scope = UI.read("scope");

                    if (UI.read("table").length > 0) {
                        parameters.table = UI.read("table");

                        if (UI.read("entry").length > 0) {
                            parameters.entry = UI.read("entry");

                            if (UI.read("key").length > 0) {
                                parameters.key = UI.read("key");

                                if (UI.read("value").length > 0) {
                                    parameters.value = UI.read("value");
                                }
                            }
                        }
                    }
                }
            }

            let callback = (result) => {
                // Write output
                UI.write("output", result);

                // Show results
                UI.view("results");
            };

            // Call the database
            Database.execute(action, parameters).then(callback).catch(callback);
        }

        function download() {
            // Create element
            let element = document.createElement("a");

            // Set attributes
            element.setAttribute("href", URL.createObjectURL(new Blob([UI.read("output")], {type: "text/plain"})));
            element.setAttribute("download", Date.now() + ".txt");

            // Click on element
            element.click();
        }

        class Database {

            /**
             * Executes a database request.
             * @param action Action
             * @param parameters Parameters
             * @returns Promise
             */
            static execute(action, parameters) {
                // Create a promise
                return new Promise((resolve, reject) => {
                    // Create a form
                    let form = new FormData();

                    // Append parameters to form
                    for (let key in parameters) {
                        if (parameters.hasOwnProperty(key))
                            form.append(key, parameters[key]);
                    }

                    // Send the request
                    fetch("/?" + action.toLowerCase(), {
                        method: "post",
                        body: form
                    }).then(response => {
                        // Parse response as JSON
                        response.json().then(result => {
                            // Check the result's integrity
                            if (result.hasOwnProperty("status") && result.hasOwnProperty("result")) {
                                // Callbacks
                                if (result["status"]) {
                                    resolve(result["result"]);
                                } else {
                                    reject(result["result"]);
                                }
                            } else {
                                reject("API response malformed");
                            }
                        });
                    });
                });
            }
        }
    </script>
    <!-- Additional -->
</head>
<body onload="load()" column>
<div id="access">
    <!-- Titles -->
    <p large left>Access database</p>
    <p small left>Please provide your database access token.</p>
    <!-- Inputs -->
    <input small left id="token" placeholder="Token"/>
    <!-- Buttons -->
    <button small center onclick="UI.view('manage');">Continue</button>
    <!-- Help -->
    <p tiny center onclick="UI.view('issue');">Don't have one?</p>
</div>
<div id="issue" hidden>
    <!-- Titles -->
    <p large left>Issue token</p>
    <p small left>Please provide your database password.</p>
    <!-- Inputs -->
    <input small left id="password" placeholder="Password" type="password"/>
    <!-- Buttons -->
    <button small center onclick="issue();">Continue</button>
    <!-- Help -->
    <p tiny center onclick="UI.view('access');">Already have one?</p>
</div>
<div id="manage" hidden>
    <!-- Titles -->
    <p large left>Manage database</p>
    <p small left>Please provide the information you want to modify.</p>
    <!-- Inputs -->
    <select button small left style="-webkit-appearance: none;" id="action">
        <option>Check</option>
        <option>Insert</option>
        <option>Remove</option>
        <option>Read</option>
        <option>Write</option>
    </select>
    <div row>
        <input small left id="scope" placeholder="Scope / Service"/>
        <input small left id="table" placeholder="Table / API"/>
    </div>
    <div row>
        <input small left id="entry" placeholder="Entry / Row"/>
        <input small left id="key" placeholder="Key / Cell"/>
    </div>
    <div row>
        <input small left id="value" placeholder="Value"/>
    </div>
    <!-- Buttons -->
    <button small center onclick="execute();">Execute</button>
</div>
<div id="results" hidden>
    <!-- Titles -->
    <p large left>Execution results</p>
    <p small left>Here are the results for the action you performed.</p>
    <!-- Results -->
    <p small left id="output"></p>
    <!-- Buttons -->
    <button small center onclick="download();">Download as file</button>
</div>
</body>
</html>